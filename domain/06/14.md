JPA 2.0 added support for derived identifiers which allow an entity to borrow the identifier from a many-to-one or one-to-one association.


# Derived identifier with @MapsId
```java
package org.example.demo.hibernate;

import javax.persistence.Entity;
import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.ManyToOne;
import javax.persistence.MapsId;
import javax.persistence.Persistence;

public class Test {
    public static void main(String[] args) {
        EntityManagerFactory factory = Persistence.createEntityManagerFactory("test");
        EntityManager em = factory.createEntityManager();

        Person p = new Person();
        PersonDetails pd = new PersonDetails();
        pd.person = p;
        pd.nickName = "bill";

        em.getTransaction().begin();
        em.persist(p);
        em.persist(pd);
        em.getTransaction().commit();

        em.close();
        factory.close();
    }

    @Entity(name = "Person")
    public static class Person {
        @Id
        @GeneratedValue
        private Long id;
    }

    @Entity(name = "PersonDetails")
    public static class PersonDetails {
        @Id
        private Long id;
        String nickName;

        @ManyToOne
        @MapsId
        private Person person;
    }
}
```


生成 SQL
```sql
alter table PersonDetails drop constraint FK8c9ip9bcimb1rv32v062tm7qb
drop table if exists Person cascade
drop table if exists PersonDetails cascade
drop sequence if exists hibernate_sequence

create sequence hibernate_sequence start 1 increment 1
create table Person (id int8 not null, primary key (id))
create table PersonDetails (nickName varchar(255), person_id int8 not null, primary key (person_id))
alter table PersonDetails add constraint FK8c9ip9bcimb1rv32v062tm7qb foreign key (person_id) references Person
select nextval ('hibernate_sequence')
insert into Person (id) values (1)
insert into PersonDetails (nickName, person_id) values ('bill', 1)
```


The @MapsId annotation can also reference columns from an @EmbeddedId identifier as well.


# Derived identifier @PrimaryKeyJoinColumn
```java
package org.example.demo.hibernate;

import javax.persistence.Entity;
import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.ManyToOne;
import javax.persistence.Persistence;
import javax.persistence.PrimaryKeyJoinColumn;

public class Test {
    public static void main(String[] args) {
        EntityManagerFactory factory = Persistence.createEntityManagerFactory("test");
        EntityManager em = factory.createEntityManager();

        Person p = new Person();
        PersonDetails pd = new PersonDetails();
        pd.nickName = "bill";

        em.getTransaction().begin();
        em.persist(p);

        pd.person = p;
        pd.id = p.id;
        em.persist(pd);
        em.getTransaction().commit();

        em.close();
        factory.close();
    }

    @Entity(name = "Person")
    public static class Person {
        @Id
        @GeneratedValue
        private Long id;
    }

    @Entity(name = "PersonDetails")
    public static class PersonDetails {
        @Id
        private Long id;
        String nickName;

        @ManyToOne
        @PrimaryKeyJoinColumn
        private Person person;
    }
}
```


生成 SQL
```sql
alter table PersonDetails drop constraint FK8c9ip9bcimb1rv32v062tm7qb
drop table if exists Person cascade
drop table if exists PersonDetails cascade
drop sequence if exists hibernate_sequence

create sequence hibernate_sequence start 1 increment 1
create table Person (id int8 not null, primary key (id))
create table PersonDetails (id int8 not null, nickName varchar(255), person_id int8, primary key (id))
alter table PersonDetails add constraint FK8c9ip9bcimb1rv32v062tm7qb foreign key (person_id) references Person
select nextval ('hibernate_sequence')
insert into Person (id) values (1)
insert into PersonDetails (nickName, person_id, id) values ('bill', 1, 1)
```


注意，这时 PersonDetails 是有自己的 id 栏位的，与 person_id 不是同一个栏位。


注意，使用 @PrimaryKeyJoinColumn 时，需要自己设置 `pd.id = p.id;` 即第 25 行。只有第 24 行的 `pd.person = p;` 是不够的，会抛异常 org.hibernate.id.IdentifierGenerationException: ids for this class must be manually assigned beforeQuery calling save(): org.example.demo.hibernate.Test$PersonDetails


如果在 PersonDetails.id 上加上 @GeneratedValue 则不需要设置 `pd.id = p.id;`


@PrimaryKeyJoinColumn 与 @JoinColumn 好像没有差别！而与 @MapsId 有很大不同。
